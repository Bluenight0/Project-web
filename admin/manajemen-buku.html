<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Manajemen Buku</title>
  </head>

  <body class="bg-gray-100 min-h-screen text-gray-800">
    <!-- Header -->
     <header class="fixed top-0 left-0 w-full bg-gray-700/80 backdrop-blur-md z-20 shadow-lg">
    <nav class="flex flex-wrap justify-between items-center p-3 max-w-6xl mx-auto">
      <a href="dashboard.html" class="bg-white/10 text-white rounded-2xl px-3 py-1 hover:bg-gray-400 transition font-semibold shadow-lg">Admin</a>
      <div class="flex flex-wrap gap-3 mt-2 sm:mt-0">
        <a href="status-buku.php" class="bg-white/10 text-white/80 rounded-2xl px-3 py-1 hover:bg-gray-400 transition font-semibold shadow-lg">Status Buku</a>
        <a href="manajemen-buku.html" class="bg-white/10 text-white/80 rounded-2xl px-3 py-1 hover:bg-gray-400 transition font-semibold shadow-lg">Data Buku</a>
        <a href="manajemen-event.html" class="bg-white/10 text-white/80 rounded-2xl px-3 py-1 hover:bg-gray-400 transition font-semibold shadow-lg">Data events</a>
        <a href="../login.html" class="bg-white/10 text-white/80 rounded-2xl px-3 py-1 hover:bg-gray-400 transition font-semibold shadow-lg">Login</a>
      </div>
    </nav>
  </header>

    <main class="pt-24 px-4 sm:px-6 flex flex-col items-center">
      <section class="w-full max-w-5xl bg-white rounded-2xl shadow-md p-6">
        <!-- Tombol CRUD -->
        <div class="flex justify-between flex-wrap mb-6 gap-3">
          <div class="flex gap-3">
            <button
              class="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded-lg shadow transition"
              onclick="showForm('add')"
            >
              Tambah Manual
            </button>
            <button
              id="btnEdit"
              class="bg-yellow-400 text-white font-semibold px-4 py-2 rounded-lg shadow opacity-50 cursor-not-allowed"
              disabled
            >
              Edit
            </button>
            <button
              id="btnDelete"
              class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg shadow opacity-50 cursor-not-allowed"
              disabled
            >
              Hapus
            </button>
          </div>

          <!-- Pencarian Google -->
          <div class="flex gap-2 items-center w-full md:w-auto">
            <input
              type="text"
              id="searchBook"
              placeholder="Cari buku di Google..."
              class="border border-gray-300 rounded-lg p-2 w-full md:w-64 focus:ring focus:ring-blue-300"
            />
            <button
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold"
              onclick="searchGoogleBooks()"
            >
              Cari
            </button>
          </div>
        </div>

        <div id="searchResults" class="grid md:grid-cols-3 gap-4 mb-6"></div>

        <!-- Form Buku -->
        <form id="formBuku" class="hidden mb-6 border p-4 bg-gray-50 rounded-xl" onsubmit="saveBook(event)">
          <input type="hidden" id="editId" />
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block font-semibold text-gray-700">Nama Buku</label>
              <input id="nama" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300" />
            </div>
            <div>
              <label class="block font-semibold text-gray-700">Jenis Buku</label>
              <select id="jenis" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300">
                <option value="">-- Pilih Jenis Buku --</option>
                <option value="Novel">Novel</option>
                <option value="Komik">Komik</option>
                <option value="Majalah">Majalah</option>
                <option value="Ensiklopedia">Ensiklopedia</option>
                <option value="Pelajaran">Pelajaran</option>
              </select>
            </div>
            <div>
              <label class="block font-semibold text-gray-700">Tanggal</label>
              <input type="date" id="tanggal" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300" />
            </div>
          </div>
          <div class="flex justify-end mt-4 gap-2">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button>
            <button type="button" onclick="toggleForm(false)" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold">Batal</button>
          </div>
        </form>

        <!-- Tabel Buku -->
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-300 rounded-lg overflow-hidden">
            <thead class="bg-gray-700 text-white">
              <tr>
                <th class="px-4 py-2 text-left">Nama</th>
                <th class="px-4 py-2 text-left">Jenis Buku</th>
                <th class="px-4 py-2 text-left">Tanggal</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="text-gray-700 bg-white"></tbody>
          </table>
        </div>
      </section>
    </main>

    <style>
      .menu-item {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
        border-radius: 1rem;
        padding: 0.25rem 0.75rem;
        font-weight: 600;
        transition: 0.3s;
      }
      .menu-item:hover {
        background: rgba(156, 163, 175, 0.6);
        color: white;
      }
    </style>

    <script>
      let books = [];
      let selected = null;

      // =============================
      // Load data dari database
      // =============================
      async function loadBooks() {
        const res = await fetch("../back-end/buku.php");
        books = await res.json();
        selected = null;
        updateActionButtons();
        renderTable();
      }

      // =============================
      // Render tabel data buku
      // =============================
      function renderTable() {
        const body = document.getElementById("tableBody");
        body.innerHTML = "";
        books.forEach((b, i) => {
          const row = document.createElement("tr");
          row.className =
            "hover:bg-gray-100 cursor-pointer" + (selected === i ? " bg-blue-100" : "");
          row.onclick = () => selectRow(i);
          row.innerHTML = `
            <td class="px-4 py-2 border-t">${b.nama}</td>
            <td class="px-4 py-2 border-t">${b.jenis}</td>
            <td class="px-4 py-2 border-t">${b.tanggal}</td>
          `;
          body.appendChild(row);
        });
      }

      // =============================
      // Pilih baris tabel
      // =============================
      function selectRow(i) {
        selected = i;
        updateActionButtons();
        renderTable();
      }

      // =============================
      // Update tombol edit/hapus
      // =============================
      function updateActionButtons() {
        const btnEdit = document.getElementById("btnEdit");
        const btnDelete = document.getElementById("btnDelete");
        const isSelected = selected !== null;

        [btnEdit, btnDelete].forEach((btn) => {
          btn.disabled = !isSelected;
          btn.classList.toggle("opacity-50", !isSelected);
          btn.classList.toggle("cursor-not-allowed", !isSelected);
        });

        if (isSelected) {
          btnEdit.onclick = () => showForm("edit");
          btnDelete.onclick = deleteBook;
        }
      }

      // =============================
      // Tampilkan / sembunyikan form
      // =============================
      function toggleForm(show) {
        document.getElementById("formBuku").classList.toggle("hidden", !show);
      }

      function showForm(mode) {
        toggleForm(true);
        const form = document.getElementById("formBuku");
        form.reset();

        if (mode === "edit" && selected !== null) {
          const b = books[selected];
          document.getElementById("editId").value = b.id;
          document.getElementById("nama").value = b.nama;
          document.getElementById("jenis").value = b.jenis;
          document.getElementById("tanggal").value = b.tanggal;
        } else {
          document.getElementById("editId").value = "";
        }
      }

      // =============================
      // Simpan (Tambah/Edit)
      // =============================
      async function saveBook(e) {
        e.preventDefault();

        const id = document.getElementById("editId").value;
        const data = {
          id,
          nama: document.getElementById("nama").value.trim(),
          jenis: document.getElementById("jenis").value,
          tanggal: document.getElementById("tanggal").value,
        };

        const method = id ? "PUT" : "POST";

        const res = await fetch("../back-end/buku.php", {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();
        if (result.status === "success") {
          toggleForm(false);
          await loadBooks();
        } else {
          alert("Gagal menyimpan buku!");
        }
      }

      // =============================
      // Hapus buku
      // =============================
      async function deleteBook() {
        if (selected === null) return;
        const id = books[selected].id;

        if (confirm("Yakin ingin menghapus buku ini?")) {
          await fetch("../back-end/buku.php", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });
          await loadBooks();
        }
      }

      // =============================
      // Cari dari Google Books API
      // =============================
      async function searchGoogleBooks() {
        const query = document.getElementById("searchBook").value.trim();
        const container = document.getElementById("searchResults");
        container.innerHTML = "";

        if (!query) return alert("Masukkan kata kunci buku!");

        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (!data.items) {
          container.innerHTML = "<p>Tidak ada hasil.</p>";
          return;
        }

        data.items.slice(0, 6).forEach((item) => {
          const info = item.volumeInfo;
          const title = info.title || "Tanpa Judul";
          const thumb = info.imageLinks?.thumbnail || "";
          const kategori = info.categories?.[0] || "Umum";

          const div = document.createElement("div");
          div.className = "border rounded-lg p-3 bg-gray-50 flex flex-col items-center";
          div.innerHTML = `
            <img src="${thumb}" class="w-24 h-32 object-cover mb-2 rounded">
            <p class="font-semibold text-center mb-1">${title}</p>
            <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm"
              onclick='addFromGoogle(${JSON.stringify({ title, kategori, thumb })})'>
              Tambah ke Daftar
            </button>
          `;
          container.appendChild(div);
        });
      }

      // =============================
      // Tambah dari Google API
      // =============================
      async function addFromGoogle(book) {
        const today = new Date().toISOString().split("T")[0];
        const newBook = {
          nama: book.title,
          jenis: book.kategori,
          tanggal: today,
          gambar: book.thumb,
        };

        const res = await fetch("../back-end/buku.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newBook),
        });

        const result = await res.json();
        if (result.status === "success") {
          alert(`"${book.title}" berhasil ditambahkan ke database.`);
          await loadBooks();
        } else {
          alert("Gagal menyimpan ke database.");
        }
      }

      loadBooks();
    </script>
  </body>
</html>
